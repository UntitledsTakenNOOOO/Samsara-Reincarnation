// Tokens

actor DGHasBFG9000 : Boolean {}
actor SamsaraDoomOriginalLoadoutSlot7 : Counter { Inventory.MaxAmount 2 }

// B.F.G. 9000

actor SamsaraDoomguyStrBFGReadySoundCheck : Boolean {}

actor "B.F.G. 9000" : BFG9000
{
	//Weapon.SlotNumber 7
	Weapon.SlotPriority 1
	Weapon.AmmoGive 0 // 40
	Obituary "$SAMSARA_DOOMGUY_OB_SLOT7_1"
	Inventory.RestrictedTo "DoomguyPlayer"
	Tag "B.F.G. 9000"
	+AMMO_OPTIONAL
	+NOALERT
	+UNDROPPABLE
	+WEAPON.BFG
	States
	{
	Spawn:
		WBFG A -1
		stop

	// Original
	Ready:
		TNT1 A 0 A_JumpIfInventory("DoomClassMode",2,"ReadyStr")
		TNT1 A 0 A_JumpIfInventory("DoomClassMode",1,"Ready64")
		TNT1 A 0 A_JumpIfInventory("SamsaraDoomguyStrBFGReadySoundCheck",1,"ReadyStopSound")
	ReadyContinue:
		DBFG A 1 A_WeaponReady
		goto Ready

	ReadyStopSound:
		TNT1 A 0 A_PlaySound("silence",CHAN_6)
		TNT1 A 0 A_StopSound(CHAN_6)
		TNT1 A 0 A_TakeInventory("SamsaraDoomguyStrBFGReadySoundCheck")
		goto ReadyContinue

	Deselect:
		TNT1 A 0 A_JumpIfInventory("SamsaraDoomguyStrBFGReadySoundCheck",1,"DeselectStopSound")
	DeselectStart:
		TNT1 A 0 A_JumpIfInventory("DoomClassMode",2,"DeselectStartStr")
		TNT1 A 0 A_JumpIfInventory("DoomClassMode",1,"DeselectStart64")
		DBFG A 1 A_Lower
		goto Deselect

	DeselectStopSound:
		TNT1 A 0 A_PlaySound("silence",CHAN_6)
		TNT1 A 0 A_StopSound(CHAN_6)
		TNT1 A 0 A_TakeInventory("SamsaraDoomguyStrBFGReadySoundCheck")
		goto DeselectStart

	Select:
		TNT1 A 0 A_TakeInventory("SamsaraDoomguyStrBFGReadySoundCheck")
		TNT1 A 0 A_JumpIfInventory("DoomClassMode",2,"SelectStr")
		TNT1 A 0 A_JumpIfInventory("DoomClassMode",1,"Select64")
		DBFG A 1 A_Raise
		loop

	Fire:
		TNT1 A 0 A_JumpIfInventory("DoomClassMode",2,"FireStr")
		TNT1 A 0 A_JumpIfInventory("DoomClassMode",1,"Fire64")
		TNT1 A 0 A_JumpIfInventory("SamsaraHasInfiniteAmmo",1,2)
		TNT1 A 0 A_JumpIfInventory("Cell",40,1)
		goto Nothing
		TNT1 A 0 A_JumpIfInventory("SamsaraDoomguyStrBFGReadySoundCheck",1,"FireStopSound")
	FireStart:
		TNT1 A 0 A_AlertMonsters
		TNT1 A 0 A_GiveInventory("SamsaraDoomguyBFG9000PreFireSoundPlayer")
		TNT1 A 0 A_JumpIfInventory("SamsaraUsingSmoothAnims",1,"FireSmooth")
	FireVanilla:
		DBFG A 20
		DBFG B 10 Bright A_GunFlash
		DBFG B 10 Bright A_GiveInventory("SamsaraDoomguyBFG9000AttackHandler")
		TNT1 A 0 A_JumpIfInventory("SamsaraHasInfiniteAmmo",1,2)
		TNT1 A 0 A_JumpIfInventory("Cell",40,1)
		goto Nothing
		DBFG B 20 A_ReFire
		goto Ready

	FireSmooth:
		SFGG J 4 A_JumpIfInventory("SamsaraHasDoubleFiringSpeed",1,"FireSmoothRage")
		SFGG AJAJ 3
		SFGG AJ 2
		SFGG KB 1
		SFGG C 1 A_GunFlash
		SFGX A 1
		SFGG DEF 2
		SFGG G 2 bright A_GiveInventory("SamsaraDoomguyBFG9000AttackHandler")
		SFGG H 1 bright offset(0,37)
		SFGG H 1 bright offset(0,37) 
		SFGG I 1 bright offset(0,35)
		SFGG I 1 bright offset(0,35)
		SFGG I 1 bright offset(0,35)
		SFGG J 3 offset(0,34)
		TNT1 A 0 A_JumpIfInventory("SamsaraHasInfiniteAmmo",1,2)
		TNT1 A 0 A_JumpIfInventory("Cell",40,1)
		goto Nothing
		SFGG J 2 A_Refire
		SFGG A 3 offset(0,33)
		SFGG A 15
		goto Ready

	FireSmoothRage:
		SFGG J 4
		SFGG AJAJ 1
		SFGG A 1
		SFGG KB 1
		SFGG C 1 A_GunFlash
		SFGG ADEF 1
		SFGG G 1 bright A_GiveInventory("SamsaraDoomguyBFG9000AttackHandler")
		SFGG H 1 bright offset(0,37)
		SFGG I 1 bright offset(0,35)
		SFGG I 1 bright offset(0,35)
		SFGG J 3 offset(0,34)
		TNT1 A 0 A_JumpIfInventory("SamsaraHasInfiniteAmmo",1,2)
		TNT1 A 0 A_JumpIfInventory("Cell",40,1)
		goto Nothing
		SFGG J 2 A_Refire
		SFGG A 3 offset(0,33)
		SFGG A 14
		goto Ready

	FireStopSound:
		TNT1 A 0 A_PlaySound("silence",CHAN_6)
		TNT1 A 0 A_StopSound(CHAN_6)
		TNT1 A 0 A_TakeInventory("SamsaraDoomguyStrBFGReadySoundCheck")
		goto FireStart

	Flash:
		TNT1 A 0 A_JumpIfInventory("SamsaraUsingSmoothAnims",1,"FlashSmooth")
		DBFF A 11 bright A_Light1
		DBFF B 6 bright A_Light2
		goto LightDone
		
	FlashSmooth:
		TNT1 A 11 bright A_Light1
		TNT1 A 6 bright A_Light2
		goto LightDone

	// Doom 64 (fires slightly slower, has blend effect on projectile impact)
	Ready64:
		TNT1 A 0 A_JumpIfInventory("SamsaraDoomguyStrBFGReadySoundCheck",1,"Ready64StopSound")
	Ready64Continue:
		64BF A 1 A_WeaponReady
		goto Ready

	Ready64StopSound:
		TNT1 A 0 A_PlaySound("silence",CHAN_6)
		TNT1 A 0 A_StopSound(CHAN_6)
		TNT1 A 0 A_TakeInventory("SamsaraDoomguyStrBFGReadySoundCheck")
		goto Ready64Continue

	DeselectStart64:
		64BF A 1 A_Lower
		goto Deselect

	Select64:
		64BF A 1 A_Raise
		goto Select

	Fire64:
		TNT1 A 0 A_JumpIfInventory("SamsaraHasInfiniteAmmo",1,2)
		TNT1 A 0 A_JumpIfInventory("Cell",40,1)
		goto Nothing
		TNT1 A 0 A_JumpIfInventory("SamsaraDoomguyStrBFGReadySoundCheck",1,"Fire64StopSound")
	Fire64Start:
		TNT1 A 0 A_AlertMonsters
		TNT1 A 0 A_PlaySound("doom64guy/bfgf",CHAN_WEAPON)
		TNT1 A 0 A_JumpIfInventory("SamsaraUsingSmoothAnims",1,"Fire64Smooth")
	Fire64Vanilla:
		64BF A 20
		64BF A 10 A_GunFlash("Flash64")
		64BF B 5
		64BF B 10 A_GiveInventory("SamsaraDoomguy64BFG9000AttackHandler")
		TNT1 A 0 A_JumpIfInventory("SamsaraHasInfiniteAmmo",1,2)
		TNT1 A 0 A_JumpIfInventory("Cell",40,1)
		goto Nothing
		64BF B 25 A_ReFire
		goto Ready

	Fire64Smooth:
		64BF A 20
		
		64BF A 2 A_GunFlash("Flash64Smooth")
		64BF A 8

		64BF B 5
		
		64BF D 1 A_GiveInventory("SamsaraDoomguy64BFG9000AttackHandler")
		64BF D 1
		64BF EDC 2
		64BF BA 1
		
		TNT1 A 0 A_JumpIfInventory("SamsaraHasInfiniteAmmo",1,2)
		TNT1 A 0 A_JumpIfInventory("Cell",40,1)
		goto Nothing
		64BF A 25 A_ReFire
		goto Ready

	Fire64StopSound:
		TNT1 A 0 A_PlaySound("silence",CHAN_6)
		TNT1 A 0 A_StopSound(CHAN_6)
		TNT1 A 0 A_TakeInventory("SamsaraDoomguyStrBFGReadySoundCheck")
		goto Fire64Start

	Flash64:
		64BM A 11 Bright A_Light1
		64BM B 5 Bright
		64BM C 5 Bright A_Light2
		goto LightDone
		
	Flash64Smooth:
		TNT1 A 2
		64BM D 4 Bright A_Light1
		64BM E 3 Bright A_Light1
		64BM F 2 Bright A_Light1
		
		64BM GHIJ 1 Bright A_Light2
		64BM K 1 Bright A_Light2
		
		//64BM K 1 Bright A_Light2
		//64BM K 1 Bright //A_Light2
		//64BM GFED 1 Bright A_Light1
		//64BM C 5 Bright A_Light2
		goto LightDone

	// Stronghold
	ReadyStr:
		TNT1 A 0 A_PlaySound("doomguy/stronghold/bfghum",CHAN_6,1,true)
		TNT1 A 0 A_GiveInventory("SamsaraDoomguyStrBFGReadySoundCheck")
		DBFG DEFG 3 Bright A_WeaponReady
		goto Ready

	// Unpowered
	DeselectStartStr:
		TNT1 A 0 A_JumpIfInventory("PowerSamsaraDoomguyStrWeaponPower",1,"DeselectStartStrPowered")
		TNT1 A 0 A_JumpIfInventory("SamsaraHasPermaWeaponLevel2",1,"DeselectStartStrPowered")
	DeselectStartStrContinue:
		TNT1 A 0 A_Lower
		DBFG R 1 A_Lower
		goto Deselect

	SelectStr:
		TNT1 A 0 A_JumpIfInventory("PowerSamsaraDoomguyStrWeaponPower",1,"SelectStrPowered")
		TNT1 A 0 A_JumpIfInventory("SamsaraHasPermaWeaponLevel2",1,"SelectStrPowered")
	SelectStrContinue:
		TNT1 A 0 A_Raise
		DBFG R 1 A_Raise
		goto Select

	FireStr:
		TNT1 A 0 A_JumpIfInventory("PowerSamsaraDoomguyStrWeaponPower",1,"FireStrPowered")
		TNT1 A 0 A_JumpIfInventory("SamsaraHasPermaWeaponLevel2",1,"FireStrPowered")
		TNT1 A 0 A_JumpIfInventory("SamsaraHasInfiniteAmmo",1,2)
		TNT1 A 0 A_JumpIfInventory("Cell",40,1)
		goto Nothing
		TNT1 A 0 A_JumpIfInventory("SamsaraDoomguyStrBFGReadySoundCheck",1,"FireStrStopSound")
	FireStrStart:
		TNT1 A 0 A_AlertMonsters
		TNT1 A 0 A_GiveInventory("SamsaraDoomguyStrBFG9000PreFireSoundPlayer")
		DBFG IJKLM 5 Bright
		DBFG N 5 Bright A_GunFlash("FlashStr")
		TNT1 A 0 A_JumpIfInventory("SamsaraImprovedDoomguyBalance",1,"FireStrFinishImproved")
	FireStrFinishVanilla:
		DBFG O 5 Bright A_GiveInventory("SamsaraDoomguyStrBFG9000AttackHandler")
		DBFG P 5 Bright
		TNT1 A 0 A_JumpIfInventory("SamsaraHasInfiniteAmmo",1,2)
		TNT1 A 0 A_JumpIfInventory("Cell",40,1)
		goto Nothing
		DBFG Q 5 Bright A_ReFire
		DBFG H 15 Bright
		goto Ready

	FireStrFinishImproved:
		DBFG O 5 Bright A_GiveInventory("SamsaraDoomguyStrBFG9000AttackHandler")
		DBFG P 5 Bright
		TNT1 A 0 A_JumpIfInventory("SamsaraHasInfiniteAmmo",1,2)
		TNT1 A 0 A_JumpIfInventory("Cell",40,1)
		goto Nothing
		DBFG Q 5 Bright A_ReFire
		TNT1 A 0 A_JumpIfInventory("SamsaraHasInfiniteAmmo",1,2)
		TNT1 A 0 A_JumpIfInventory("Cell",40,1)
		goto Nothing
		DBFG H 5 Bright A_ReFire
		TNT1 A 0 A_JumpIfInventory("SamsaraHasInfiniteAmmo",1,2)
		TNT1 A 0 A_JumpIfInventory("Cell",40,1)
		goto Nothing
		DBFG H 5 Bright A_ReFire
		TNT1 A 0 A_JumpIfInventory("SamsaraHasInfiniteAmmo",1,2)
		TNT1 A 0 A_JumpIfInventory("Cell",40,1)
		goto Nothing
		DBFG H 5 Bright A_ReFire
		goto Ready

	FireStrStopSound:
		TNT1 A 0 A_PlaySound("silence",CHAN_6)
		TNT1 A 0 A_StopSound(CHAN_6)
		TNT1 A 0 A_TakeInventory("SamsaraDoomguyStrBFGReadySoundCheck")
		goto FireStrStart

	FlashStr:
		TNT1 A 5 A_Light1
		TNT1 A 5 A_Light2
		TNT1 A 5 A_Light1
		goto LightDone

	// Powered
	DeselectStartStrPowered:
		TNT1 A 0 A_Lower
		goto DeselectStartStrContinue

	SelectStrPowered:
		TNT1 A 0 A_Raise
		goto SelectStrContinue

	FireStrPowered:
		TNT1 A 0 A_JumpIfInventory("SamsaraHasInfiniteAmmo",1,2)
		TNT1 A 0 A_JumpIfInventory("Cell",5,1)
		goto Nothing
		TNT1 A 0 A_JumpIfInventory("SamsaraDoomguyStrBFGReadySoundCheck",1,"FireStrPoweredStopSound")
	FireStrPoweredStart:
		TNT1 A 0 A_AlertMonsters
		DBFG IKM 1 Bright
		DBFG N 1 Bright A_GunFlash("FlashStrPowered")
		TNT1 A 0 A_GiveInventory("SamsaraDoomguyStrBFG9000PoweredAttackHandler")
		DBFG OQ 1 Bright
		TNT1 A 0 A_JumpIfInventory("SamsaraHasInfiniteAmmo",1,2)
		TNT1 A 0 A_JumpIfInventory("Cell",5,1)
		goto Nothing
		DBFG H 7 Bright A_ReFire
		goto Ready

	FireStrPoweredStopSound:
		TNT1 A 0 A_PlaySound("silence",CHAN_6)
		TNT1 A 0 A_StopSound(CHAN_6)
		TNT1 A 0 A_TakeInventory("SamsaraDoomguyStrBFGReadySoundCheck")
		goto FireStrPoweredStart

	FlashStrPowered:
		TNT1 A 1 A_Light1
		TNT1 A 1 A_Light2
		TNT1 A 1 A_Light1
		goto LightDone

	Nothing:
        TNT1 A 0 A_ClearReFire
        TNT1 A 0 A_JumpIfInventory("DoomClassMode",2,"NothingStr")
        TNT1 A 0 A_JumpIfInventory("DoomClassMode",1,"Nothing64")
        TNT1 A 0 A_JumpIfInventory("SamsaraDoomOriginalLoadoutFallbackRanged",1,2)
        TNT1 A 0 A_SelectWeapon(" Pistol ")
        goto Deselect
        TNT1 A 0 A_SelectWeapon(" Rifle ")
        goto Deselect

	Nothing64:
	NothingStr:
        TNT1 A 0 A_SelectWeapon(" Pistol ")
        goto Deselect
	}
}

actor SamsaraDoomguyBFG9000AttackHandler : Trigger
{
    States
    {
      // Ammo checking/taking stuff
      Pickup:
        TNT1 A 0 A_JumpIfInventory("SamsaraHasInfiniteAmmo",1,"PickupAttack")
        TNT1 A 0 A_JumpIfInventory("Cell",40,1)
        stop
        TNT1 A 0 A_TakeInventory("Cell",40)
        goto PickupAttack

      // Attack stuff
      PickupAttack:
        TNT1 A 0 A_JumpIfInventory("DoomNoBFGAim",1,"PickupAttackNoAim")
        TNT1 A 0 A_JumpIfInventory("SamsaraImprovedDoomguyBalance",1,"PickupAttackImproved")
      // Vanilla
      PickupAttackVanilla:
        TNT1 A 0 A_JumpIfInventory("SPModeOn",1,"PickupAttackVanillaCoop")
        TNT1 A 0 A_JumpIfInventory("CoopModeOn",1,"PickupAttackVanillaCoop")
        TNT1 A 0 A_JumpIfInventory("SamsaraAlternateSoundToken",2,"PickupAttackVanillaDMSoundPerkristan")
        TNT1 A 0 A_JumpIfInventory("SamsaraAlternateSoundToken",1,"PickupAttackVanillaDMSoundPSX")
      PickupAttackVanillaDM:
        TNT1 A 0 A_FireCustomMissile("DoomBFGBallVanilla",0,false)
        stop

      PickupAttackVanillaDMSoundPSX:
        TNT1 A 0 A_FireCustomMissile("DoomBFGBallVanillaSoundPSX",0,false)
        stop

      PickupAttackVanillaDMSoundPerkristan:
        TNT1 A 0 A_FireCustomMissile("DoomBFGBallVanillaSoundPerkristan",0,false)
        stop

      PickupAttackVanillaCoop:
        TNT1 A 0 A_JumpIfInventory("SamsaraAlternateSoundToken",2,"PickupAttackVanillaCoopSoundPerkristan")
        TNT1 A 0 A_JumpIfInventory("SamsaraAlternateSoundToken",1,"PickupAttackVanillaCoopSoundPSX")
        TNT1 A 0 A_FireCustomMissile("DoomBFGBallVanilla2",0,false)
        stop

      PickupAttackVanillaCoopSoundPSX:
        TNT1 A 0 A_FireCustomMissile("DoomBFGBallVanilla2SoundPSX",0,false)
        stop

      PickupAttackVanillaCoopSoundPerkristan:
        TNT1 A 0 A_FireCustomMissile("DoomBFGBallVanilla2SoundPerkristan",0,false)
        stop

      // Improved
      PickupAttackImproved:
        TNT1 A 0 A_JumpIfInventory("SPModeOn",1,"PickupAttackImprovedCoop")
        TNT1 A 0 A_JumpIfInventory("CoopModeOn",1,"PickupAttackImprovedCoop")
        TNT1 A 0 A_JumpIfInventory("SamsaraAlternateSoundToken",2,"PickupAttackImprovedDMSoundPerkristan")
        TNT1 A 0 A_JumpIfInventory("SamsaraAlternateSoundToken",1,"PickupAttackImprovedDMSoundPSX")
      PickupAttackImprovedDM:
        TNT1 A 0 A_FireCustomMissile("DoomBFGBall",0,false)
        stop

      PickupAttackImprovedDMSoundPSX:
        TNT1 A 0 A_FireCustomMissile("DoomBFGBallSoundPSX",0,false)
        stop

      PickupAttackImprovedDMSoundPerkristan:
        TNT1 A 0 A_FireCustomMissile("DoomBFGBallSoundPerkristan",0,false)
        stop

      PickupAttackImprovedCoop:
        TNT1 A 0 A_JumpIfInventory("SamsaraAlternateSoundToken",2,"PickupAttackImprovedCoopSoundPerkristan")
        TNT1 A 0 A_JumpIfInventory("SamsaraAlternateSoundToken",1,"PickupAttackImprovedCoopSoundPSX")
        TNT1 A 0 A_FireCustomMissile("DoomBFGBall2",0,false)
        stop

      PickupAttackImprovedCoopSoundPSX:
        TNT1 A 0 A_FireCustomMissile("DoomBFGBall2SoundPSX",0,false)
        stop

      PickupAttackImprovedCoopSoundPerkristan:
        TNT1 A 0 A_FireCustomMissile("DoomBFGBall2SoundPerkristan",0,false)
        stop

      // No aiming attack stuff
      PickupAttackNoAim:
        TNT1 A 0 A_JumpIfInventory("SamsaraImprovedDoomguyBalance",1,"PickupAttackNoAimImproved")
      // Vanilla
      PickupAttackNoAimVanilla:
        TNT1 A 0 A_JumpIfInventory("SPModeOn",1,"PickupAttackNoAimVanillaCoop")
        TNT1 A 0 A_JumpIfInventory("CoopModeOn",1,"PickupAttackNoAimVanillaCoop")
        TNT1 A 0 A_JumpIfInventory("SamsaraAlternateSoundToken",2,"PickupAttackNoAimVanillaDMSoundPerkristan")
        TNT1 A 0 A_JumpIfInventory("SamsaraAlternateSoundToken",1,"PickupAttackNoAimVanillaDMSoundPSX")
      PickupAttackNoAimVanillaDM:
        TNT1 A 0 A_SpawnItemEx("DoomBFGBallVanilla",0,0,32,25)
        TNT1 A 0 A_JumpIfInventory("SamsaraHasSpread",1,1)
        stop
        TNT1 A 0 A_SpawnItemEx("DoomBFGBallVanilla",0,0,32,25,0,0,-15)
        TNT1 A 0 A_SpawnItemEx("DoomBFGBallVanilla",0,0,32,25,0,0,15)
        stop

      PickupAttackNoAimVanillaDMSoundPSX:
        TNT1 A 0 A_SpawnItemEx("DoomBFGBallVanillaSoundPSX",0,0,32,25)
        TNT1 A 0 A_JumpIfInventory("SamsaraHasSpread",1,1)
        stop
        TNT1 A 0 A_SpawnItemEx("DoomBFGBallVanillaSoundPSX",0,0,32,25,0,0,-15)
        TNT1 A 0 A_SpawnItemEx("DoomBFGBallVanillaSoundPSX",0,0,32,25,0,0,15)
        stop

      PickupAttackNoAimVanillaDMSoundPerkristan:
        TNT1 A 0 A_SpawnItemEx("DoomBFGBallVanillaSoundPerkristan",0,0,32,25)
        TNT1 A 0 A_JumpIfInventory("SamsaraHasSpread",1,1)
        stop
        TNT1 A 0 A_SpawnItemEx("DoomBFGBallVanillaSoundPerkristan",0,0,32,25,0,0,-15)
        TNT1 A 0 A_SpawnItemEx("DoomBFGBallVanillaSoundPerkristan",0,0,32,25,0,0,15)
        stop

      PickupAttackNoAimVanillaCoop:
        TNT1 A 0 A_JumpIfInventory("SamsaraAlternateSoundToken",2,"PickupAttackNoAimVanillaCoopSoundPerkristan")
        TNT1 A 0 A_JumpIfInventory("SamsaraAlternateSoundToken",1,"PickupAttackNoAimVanillaCoopSoundPSX")
        TNT1 A 0 A_SpawnItemEx("DoomBFGBallVanilla2",0,0,32,25)
        TNT1 A 0 A_JumpIfInventory("SamsaraHasSpread",1,1)
        stop
        TNT1 A 0 A_SpawnItemEx("DoomBFGBallVanilla2",0,0,32,25,0,0,-15)
        TNT1 A 0 A_SpawnItemEx("DoomBFGBallVanilla2",0,0,32,25,0,0,15)
        stop

      PickupAttackNoAimVanillaCoopSoundPSX:
        TNT1 A 0 A_SpawnItemEx("DoomBFGBallVanilla2SoundPSX",0,0,32,25)
        TNT1 A 0 A_JumpIfInventory("SamsaraHasSpread",1,1)
        stop
        TNT1 A 0 A_SpawnItemEx("DoomBFGBallVanilla2SoundPSX",0,0,32,25,0,0,-15)
        TNT1 A 0 A_SpawnItemEx("DoomBFGBallVanilla2SoundPSX",0,0,32,25,0,0,15)
        stop

      PickupAttackNoAimVanillaCoopSoundPerkristan:
        TNT1 A 0 A_SpawnItemEx("DoomBFGBallVanilla2SoundPerkristan",0,0,32,25)
        TNT1 A 0 A_JumpIfInventory("SamsaraHasSpread",1,1)
        stop
        TNT1 A 0 A_SpawnItemEx("DoomBFGBallVanilla2SoundPerkristan",0,0,32,25,0,0,-15)
        TNT1 A 0 A_SpawnItemEx("DoomBFGBallVanilla2SoundPerkristan",0,0,32,25,0,0,15)
        stop

      // Improved
      PickupAttackNoAimImproved:
        TNT1 A 0 A_JumpIfInventory("SPModeOn",1,"PickupAttackNoAimImprovedCoop")
        TNT1 A 0 A_JumpIfInventory("CoopModeOn",1,"PickupAttackNoAimImprovedCoop")
        TNT1 A 0 A_JumpIfInventory("SamsaraAlternateSoundToken",2,"PickupAttackNoAimImprovedDMSoundPerkristan")
        TNT1 A 0 A_JumpIfInventory("SamsaraAlternateSoundToken",1,"PickupAttackNoAimImprovedDMSoundPSX")
      PickupAttackNoAimImprovedDM:
        TNT1 A 0 A_SpawnItemEx("DoomBFGBall",0,0,32,25)
        TNT1 A 0 A_JumpIfInventory("SamsaraHasSpread",1,1)
        stop
        TNT1 A 0 A_SpawnItemEx("DoomBFGBall",0,0,32,25,0,0,-15)
        TNT1 A 0 A_SpawnItemEx("DoomBFGBall",0,0,32,25,0,0,15)
        stop

      PickupAttackNoAimImprovedDMSoundPSX:
        TNT1 A 0 A_SpawnItemEx("DoomBFGBallSoundPSX",0,0,32,25)
        TNT1 A 0 A_JumpIfInventory("SamsaraHasSpread",1,1)
        stop
        TNT1 A 0 A_SpawnItemEx("DoomBFGBallSoundPSX",0,0,32,25,0,0,-15)
        TNT1 A 0 A_SpawnItemEx("DoomBFGBallSoundPSX",0,0,32,25,0,0,15)
        stop

      PickupAttackNoAimImprovedDMSoundPerkristan:
        TNT1 A 0 A_SpawnItemEx("DoomBFGBallSoundPerkristan",0,0,32,25)
        TNT1 A 0 A_JumpIfInventory("SamsaraHasSpread",1,1)
        stop
        TNT1 A 0 A_SpawnItemEx("DoomBFGBallSoundPerkristan",0,0,32,25,0,0,-15)
        TNT1 A 0 A_SpawnItemEx("DoomBFGBallSoundPerkristan",0,0,32,25,0,0,15)
        stop

      PickupAttackNoAimImprovedCoop:
        TNT1 A 0 A_JumpIfInventory("SamsaraAlternateSoundToken",2,"PickupAttackNoAimImprovedCoopSoundPerkristan")
        TNT1 A 0 A_JumpIfInventory("SamsaraAlternateSoundToken",1,"PickupAttackNoAimImprovedCoopSoundPSX")
        TNT1 A 0 A_SpawnItemEx("DoomBFGBall2",0,0,32,25)
        TNT1 A 0 A_JumpIfInventory("SamsaraHasSpread",1,1)
        stop
        TNT1 A 0 A_SpawnItemEx("DoomBFGBall2",0,0,32,25,0,0,-15)
        TNT1 A 0 A_SpawnItemEx("DoomBFGBall2",0,0,32,25,0,0,15)
        stop

      PickupAttackNoAimImprovedCoopSoundPSX:
        TNT1 A 0 A_SpawnItemEx("DoomBFGBall2SoundPSX",0,0,32,25)
        TNT1 A 0 A_JumpIfInventory("SamsaraHasSpread",1,1)
        stop
        TNT1 A 0 A_SpawnItemEx("DoomBFGBall2SoundPSX",0,0,32,25,0,0,-15)
        TNT1 A 0 A_SpawnItemEx("DoomBFGBall2SoundPSX",0,0,32,25,0,0,15)
        stop

      PickupAttackNoAimImprovedCoopSoundPerkristan:
        TNT1 A 0 A_SpawnItemEx("DoomBFGBall2SoundPerkristan",0,0,32,25)
        TNT1 A 0 A_JumpIfInventory("SamsaraHasSpread",1,1)
        stop
        TNT1 A 0 A_SpawnItemEx("DoomBFGBall2SoundPerkristan",0,0,32,25,0,0,-15)
        TNT1 A 0 A_SpawnItemEx("DoomBFGBall2SoundPerkristan",0,0,32,25,0,0,15)
        stop
    }
}

actor SamsaraDoomguyBFG9000PreFireSoundPlayer : Trigger
{
    States
    {
      // Sound playing stuff
      Pickup:
        TNT1 A 0 A_JumpIfInventory("SamsaraAlternateSoundToken",2,"PickupPerkristan")
        TNT1 A 0 A_JumpIfInventory("SamsaraAlternateSoundToken",1,"PickupPSX")
      PickupOriginal:
        TNT1 A 0 A_PlaySound("doomguy/bfgf",CHAN_WEAPON)
        stop

      PickupPSX:
        TNT1 A 0 A_PlaySound("doom64guy/bfgf",CHAN_WEAPON)
        stop

      PickupPerkristan:
        TNT1 A 0 A_PlaySound("doomguy/perkristan/bfgf",CHAN_WEAPON)
        stop
    }
}

actor SamsaraDoomguy64BFG9000AttackHandler : Trigger
{
    States
    {
      // Ammo checking/taking stuff
      Pickup:
        TNT1 A 0 A_JumpIfInventory("SamsaraHasInfiniteAmmo",1,"PickupAttack")
        TNT1 A 0 A_JumpIfInventory("Cell",40,1)
        stop
        TNT1 A 0 A_TakeInventory("Cell",40)
        goto PickupAttack

      // Attack stuff
      PickupAttack:
        TNT1 A 0 A_JumpIfInventory("DoomNoBFGAim",1,"PickupAttackNoAim")
        TNT1 A 0 A_JumpIfInventory("SamsaraImprovedDoomguyBalance",1,"PickupAttackImproved")
      // Vanilla
      PickupAttackVanilla:
        TNT1 A 0 A_JumpIfInventory("SPModeOn",1,"PickupAttackVanillaCoop")
        TNT1 A 0 A_JumpIfInventory("CoopModeOn",1,"PickupAttackVanillaCoop")
      PickupAttackVanillaDM:
        TNT1 A 0 A_FireCustomMissile("Doom64BFGBallVanilla",0,false)
        stop

      PickupAttackVanillaCoop:
        TNT1 A 0 A_FireCustomMissile("Doom64BFGBallVanilla2",0,false)
        stop

      // Improved
      PickupAttackImproved:
        TNT1 A 0 A_JumpIfInventory("SPModeOn",1,"PickupAttackImprovedCoop")
        TNT1 A 0 A_JumpIfInventory("CoopModeOn",1,"PickupAttackImprovedCoop")
      PickupAttackImprovedDM:
        TNT1 A 0 A_FireCustomMissile("Doom64BFGBall",0,false)
        stop

      PickupAttackImprovedCoop:
        TNT1 A 0 A_FireCustomMissile("Doom64BFGBall2",0,false)
        stop

      // No aiming attack stuff
      PickupAttackNoAim:
        TNT1 A 0 A_JumpIfInventory("SamsaraImprovedDoomguyBalance",1,"PickupAttackNoAimImproved")
      // Vanilla
      PickupAttackNoAimVanilla:
        TNT1 A 0 A_JumpIfInventory("SPModeOn",1,"PickupAttackNoAimVanillaCoop")
        TNT1 A 0 A_JumpIfInventory("CoopModeOn",1,"PickupAttackNoAimVanillaCoop")
      PickupAttackNoAimVanillaDM:
        TNT1 A 0 A_SpawnItemEx("Doom64BFGBallVanilla",0,0,32,25)
        TNT1 A 0 A_JumpIfInventory("SamsaraHasSpread",1,1)
        stop
        TNT1 A 0 A_SpawnItemEx("Doom64BFGBallVanilla",0,0,32,25,0,0,-15)
        TNT1 A 0 A_SpawnItemEx("Doom64BFGBallVanilla",0,0,32,25,0,0,15)
        stop

      PickupAttackNoAimVanillaCoop:
        TNT1 A 0 A_SpawnItemEx("Doom64BFGBallVanilla2",0,0,32,25)
        TNT1 A 0 A_JumpIfInventory("SamsaraHasSpread",1,1)
        stop
        TNT1 A 0 A_SpawnItemEx("Doom64BFGBallVanilla2",0,0,32,25,0,0,-15)
        TNT1 A 0 A_SpawnItemEx("Doom64BFGBallVanilla2",0,0,32,25,0,0,15)
        stop

      // Improved
      PickupAttackNoAimImproved:
        TNT1 A 0 A_JumpIfInventory("SPModeOn",1,"PickupAttackNoAimImprovedCoop")
        TNT1 A 0 A_JumpIfInventory("CoopModeOn",1,"PickupAttackNoAimImprovedCoop")
      PickupAttackNoAimImprovedDM:
        TNT1 A 0 A_SpawnItemEx("Doom64BFGBall",0,0,32,25)
        TNT1 A 0 A_JumpIfInventory("SamsaraHasSpread",1,1)
        stop
        TNT1 A 0 A_SpawnItemEx("Doom64BFGBall",0,0,32,25,0,0,-15)
        TNT1 A 0 A_SpawnItemEx("Doom64BFGBall",0,0,32,25,0,0,15)
        stop

      PickupAttackNoAimImprovedCoop:
        TNT1 A 0 A_SpawnItemEx("Doom64BFGBall2",0,0,32,25)
        TNT1 A 0 A_JumpIfInventory("SamsaraHasSpread",1,1)
        stop
        TNT1 A 0 A_SpawnItemEx("Doom64BFGBall2",0,0,32,25,0,0,-15)
        TNT1 A 0 A_SpawnItemEx("Doom64BFGBall2",0,0,32,25,0,0,15)
        stop
    }
}

actor DoomBFGBall : BFGBall
{
	DamageType "DoomDamageTypeBFG"
	Decal DoomBFGLightning
	-BLOODSPLATTER
	+BRIGHT
	+DONTREFLECT
	Damage (800)
	DeathSound "doomguy/bfgx"
	Obituary "$SAMSARA_DOOMGUY_OB_SLOT7_2"
	States
	{
	Spawn:
		DBFS AB 4 bright
		loop

	Death:
		DBFE AB 8 bright
		DBFE C 8 bright A_BFGSpray("DoomBFGSplash")
		DBFE DEF 8 bright
		stop
	}
}

actor DoomBFGBall2 : DoomBFGBall
{
	Species "Player"
	+THRUSPECIES
	States
	{
	Death:
		DBFE AB 8 bright
		DBFE C 8 bright A_BFGSpray("DoomBFGSplashCoop")
		DBFE DEF 8 bright
		stop
	}
}

actor DoomBFGBallVanilla : DoomBFGBall { Damage 100 }

actor DoomBFGBallVanilla2 : DoomBFGBallVanilla
{
	Species "Player"
	+THRUSPECIES
	States
	{
	Death:
		DBFE AB 8 bright
		DBFE C 8 bright A_BFGSpray("DoomBFGSplashCoop")
		DBFE DEF 8 bright
		stop
	}
}

actor DoomBFGBallSoundPSX : DoomBFGBall { DeathSound "doom64guy/bfgx" }
actor DoomBFGBall2SoundPSX : DoomBFGBall2 { DeathSound "doom64guy/bfgx" }
actor DoomBFGBallVanillaSoundPSX : DoomBFGBallVanilla { DeathSound "doom64guy/bfgx" }
actor DoomBFGBallVanilla2SoundPSX : DoomBFGBallVanilla2 { DeathSound "doom64guy/bfgx" }

actor DoomBFGBallSoundPerkristan : DoomBFGBall { DeathSound "doomguy/perkristan/bfgx" }
actor DoomBFGBall2SoundPerkristan : DoomBFGBall2 { DeathSound "doomguy/perkristan/bfgx" }
actor DoomBFGBallVanillaSoundPerkristan : DoomBFGBallVanilla { DeathSound "doomguy/perkristan/bfgx" }
actor DoomBFGBallVanilla2SoundPerkristan : DoomBFGBallVanilla2 { DeathSound "doomguy/perkristan/bfgx" }

actor DoomBFGSplash
{
	+NOBLOCKMAP
	+CLIENTSIDEONLY
	+NOGRAVITY
	DamageType "DoomDamageTypeBFG"
	RenderStyle Add
	Alpha 0.75
	States
	{
	Spawn:
		DBFP ABCD 8 bright
		stop
	}
}

actor DoomBFGSplashCoop : DoomBFGSplash { +MTHRUSPECIES }

actor Doom64BFGImpactFlash : Trigger
{
    States
    {
      Pickup:
        TNT1 A 0 A_JumpIfInventory("WeaponFlashesAreDisabled",1,"PickupStop")
        TNT1 A 0 A_SetBlend("Green",0.45,20)
        stop
    }
}

actor Doom64BFGBall : BFGBall
{
	DamageType "DoomDamageTypeBFG"
	Renderstyle Normal
	XScale 0.81
	YScale 0.68
	Decal DoomBFGLightning
	-BLOODSPLATTER
	+BRIGHT
	+DONTREFLECT
	Damage (800)
	DeathSound "doom64guy/bfgx"
	Obituary "%k \cpvaporized\c- %o \cpwith the B.F.G. 9000.\c-"
	States
	{
	Spawn:
		64BB AB 2 bright
		loop

	Death:
		64BB C 8 bright A_GiveToTarget("Doom64BFGImpactFlash")
		64BB D 7 bright A_FadeOut(0.142857)
		64BB E 0 bright A_FadeOut(0.142857)
		64BB E 3 bright A_BFGSpray("Doom64BFGSplash")
		64BB F 3 bright A_FadeOut(0.142857)
		64BB G 3 bright A_FadeOut(0.142857)
		64BB H 3 bright A_FadeOut(0.142857)
		stop
	}
}

actor Doom64BFGBall2 : Doom64BFGBall
{
	Species "Player"
	+THRUSPECIES
	States
	{
	Death:
		64BB C 8 bright A_GiveToTarget("Doom64BFGImpactFlash")
		64BB D 7 bright A_FadeOut(0.142857)
		TNT1 A 0 A_FadeOut(0.142857)
		64BB E 3 bright A_BFGSpray("Doom64BFGSplashCoop")
		64BB FGH 3 bright A_FadeOut(0.142857)
		stop
	}
}

actor Doom64BFGBallVanilla : Doom64BFGBall { Damage 100 }

actor Doom64BFGBallVanilla2 : Doom64BFGBallVanilla
{
	Species "Player"
	+THRUSPECIES
	States
	{
	Death:
		64BB C 8 bright A_GiveToTarget("Doom64BFGImpactFlash")
		64BB D 7 bright A_FadeOut(0.142857)
		TNT1 A 0 A_FadeOut(0.142857)
		64BB E 3 bright A_BFGSpray("Doom64BFGSplashCoop")
		64BB FGH 3 bright A_FadeOut(0.142857)
		stop
	}
}

actor Doom64BFGSplash
{
	+NOBLOCKMAP
	+CLIENTSIDEONLY
	+NOGRAVITY
	XScale 0.81
	YScale 0.68
	DamageType "DoomDamageTypeBFG"
	RenderStyle Normal
	States
	{
	Spawn:
		64B2 ABCDEF 3 bright
		stop
	}
}

actor Doom64BFGSplashCoop : Doom64BFGSplash { +MTHRUSPECIES }

// Unpowered attack handler

actor SamsaraDoomguyStrBFG9000AttackHandler : Trigger
{
    States
    {
      // Ammo checking/taking stuff
      Pickup:
        TNT1 A 0 A_JumpIfInventory("SamsaraHasInfiniteAmmo",1,"PickupAttack")
        TNT1 A 0 A_JumpIfInventory("Cell",40,1)
        stop
        TNT1 A 0 A_TakeInventory("Cell",40)
        goto PickupAttack

      // Attack stuff
      PickupAttack:
        TNT1 A 0 A_JumpIfInventory("DoomNoBFGAim",1,"PickupAttackNoAim")
        TNT1 A 0 A_JumpIfInventory("SamsaraImprovedDoomguyBalance",1,"PickupAttackImproved")
      // Vanilla
      PickupAttackVanilla:
        TNT1 A 0 A_JumpIfInventory("SPModeOn",1,"PickupAttackVanillaCoop")
        TNT1 A 0 A_JumpIfInventory("CoopModeOn",1,"PickupAttackVanillaCoop")
        TNT1 A 0 A_JumpIfInventory("SamsaraAlternateSoundToken",1,"PickupAttackVanillaDMSoundDE")
      PickupAttackVanillaDM:
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyStrBFGBall",0,false)
        stop

      PickupAttackVanillaDMSoundDE:
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyStrBFGBallSoundDE",0,false)
        stop

      PickupAttackVanillaCoop:
        TNT1 A 0 A_JumpIfInventory("SamsaraAlternateSoundToken",1,"PickupAttackVanillaCoopSoundDE")
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyStrBFGBallCoop",0,false)
        stop

      PickupAttackVanillaCoopSoundDE:
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyStrBFGBallCoopSoundDE",0,false)
        stop

      // Improved
      PickupAttackImproved:
        TNT1 A 0 A_JumpIfInventory("SPModeOn",1,"PickupAttackImprovedCoop")
        TNT1 A 0 A_JumpIfInventory("CoopModeOn",1,"PickupAttackImprovedCoop")
        TNT1 A 0 A_JumpIfInventory("SamsaraAlternateSoundToken",1,"PickupAttackImprovedDMSoundDE")
      PickupAttackImprovedDM:
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyStrBFGBallImproved",0,false)
        stop

      PickupAttackImprovedDMSoundDE:
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyStrBFGBallImprovedSoundDE",0,false)
        stop

      PickupAttackImprovedCoop:
        TNT1 A 0 A_JumpIfInventory("SamsaraAlternateSoundToken",1,"PickupAttackImprovedCoopSoundDE")
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyStrBFGBallImprovedCoop",0,false)
        stop

      PickupAttackImprovedCoopSoundDE:
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyStrBFGBallImprovedCoopSoundDE",0,false)
        stop

      // No aiming attack stuff
      PickupAttackNoAim:
        TNT1 A 0 A_JumpIfInventory("SamsaraImprovedDoomguyBalance",1,"PickupAttackNoAimImproved")
      // Vanilla
      PickupAttackNoAimVanilla:
        TNT1 A 0 A_JumpIfInventory("SPModeOn",1,"PickupAttackNoAimVanillaCoop")
        TNT1 A 0 A_JumpIfInventory("CoopModeOn",1,"PickupAttackNoAimVanillaCoop")
        TNT1 A 0 A_JumpIfInventory("SamsaraAlternateSoundToken",1,"PickupAttackNoAimVanillaDMSoundDE")
      PickupAttackNoAimVanillaDM:
        TNT1 A 0 A_SpawnItemEx("SamsaraDoomguyStrBFGBall",0,0,32,25)
        TNT1 A 0 A_JumpIfInventory("SamsaraHasSpread",1,1)
        stop
        TNT1 A 0 A_SpawnItemEx("SamsaraDoomguyStrBFGBall",0,0,32,25,0,0,-15)
        TNT1 A 0 A_SpawnItemEx("SamsaraDoomguyStrBFGBall",0,0,32,25,0,0,15)
        stop

      PickupAttackNoAimVanillaDMSoundDE:
        TNT1 A 0 A_SpawnItemEx("SamsaraDoomguyStrBFGBallSoundDE",0,0,32,25)
        TNT1 A 0 A_JumpIfInventory("SamsaraHasSpread",1,1)
        stop
        TNT1 A 0 A_SpawnItemEx("SamsaraDoomguyStrBFGBallSoundDE",0,0,32,25,0,0,-15)
        TNT1 A 0 A_SpawnItemEx("SamsaraDoomguyStrBFGBallSoundDE",0,0,32,25,0,0,15)
        stop

      PickupAttackNoAimVanillaCoop:
        TNT1 A 0 A_JumpIfInventory("SamsaraAlternateSoundToken",1,"PickupAttackNoAimVanillaCoopSoundDE")
        TNT1 A 0 A_SpawnItemEx("SamsaraDoomguyStrBFGBallCoop",0,0,32,25)
        TNT1 A 0 A_JumpIfInventory("SamsaraHasSpread",1,1)
        stop
        TNT1 A 0 A_SpawnItemEx("SamsaraDoomguyStrBFGBallCoop",0,0,32,25,0,0,-15)
        TNT1 A 0 A_SpawnItemEx("SamsaraDoomguyStrBFGBallCoop",0,0,32,25,0,0,15)
        stop

      PickupAttackNoAimVanillaCoopSoundDE:
        TNT1 A 0 A_SpawnItemEx("SamsaraDoomguyStrBFGBallCoopSoundDE",0,0,32,25)
        TNT1 A 0 A_JumpIfInventory("SamsaraHasSpread",1,1)
        stop
        TNT1 A 0 A_SpawnItemEx("SamsaraDoomguyStrBFGBallCoopSoundDE",0,0,32,25,0,0,-15)
        TNT1 A 0 A_SpawnItemEx("SamsaraDoomguyStrBFGBallCoopSoundDE",0,0,32,25,0,0,15)
        stop

      // Improved
      PickupAttackNoAimImproved:
        TNT1 A 0 A_JumpIfInventory("SPModeOn",1,"PickupAttackNoAimImprovedCoop")
        TNT1 A 0 A_JumpIfInventory("CoopModeOn",1,"PickupAttackNoAimImprovedCoop")
        TNT1 A 0 A_JumpIfInventory("SamsaraAlternateSoundToken",1,"PickupAttackNoAimImprovedDMSoundDE")
      PickupAttackNoAimImprovedDM:
        TNT1 A 0 A_SpawnItemEx("SamsaraDoomguyStrBFGBallImproved",0,0,32,25)
        TNT1 A 0 A_JumpIfInventory("SamsaraHasSpread",1,1)
        stop
        TNT1 A 0 A_SpawnItemEx("SamsaraDoomguyStrBFGBallImproved",0,0,32,25,0,0,-15)
        TNT1 A 0 A_SpawnItemEx("SamsaraDoomguyStrBFGBallImproved",0,0,32,25,0,0,15)
        stop

      PickupAttackNoAimImprovedDMSoundDE:
        TNT1 A 0 A_SpawnItemEx("SamsaraDoomguyStrBFGBallImprovedSoundDE",0,0,32,25)
        TNT1 A 0 A_JumpIfInventory("SamsaraHasSpread",1,1)
        stop
        TNT1 A 0 A_SpawnItemEx("SamsaraDoomguyStrBFGBallImprovedSoundDE",0,0,32,25,0,0,-15)
        TNT1 A 0 A_SpawnItemEx("SamsaraDoomguyStrBFGBallImprovedSoundDE",0,0,32,25,0,0,15)
        stop

      PickupAttackNoAimImprovedCoop:
        TNT1 A 0 A_JumpIfInventory("SamsaraAlternateSoundToken",1,"PickupAttackNoAimImprovedCoopSoundDE")
        TNT1 A 0 A_SpawnItemEx("SamsaraDoomguyStrBFGBallImprovedCoop",0,0,32,25)
        TNT1 A 0 A_JumpIfInventory("SamsaraHasSpread",1,1)
        stop
        TNT1 A 0 A_SpawnItemEx("SamsaraDoomguyStrBFGBallImprovedCoop",0,0,32,25,0,0,-15)
        TNT1 A 0 A_SpawnItemEx("SamsaraDoomguyStrBFGBallImprovedCoop",0,0,32,25,0,0,15)
        stop

      PickupAttackNoAimImprovedCoopSoundDE:
        TNT1 A 0 A_SpawnItemEx("SamsaraDoomguyStrBFGBallImprovedCoopSoundDE",0,0,32,25)
        TNT1 A 0 A_JumpIfInventory("SamsaraHasSpread",1,1)
        stop
        TNT1 A 0 A_SpawnItemEx("SamsaraDoomguyStrBFGBallImprovedCoopSoundDE",0,0,32,25,0,0,-15)
        TNT1 A 0 A_SpawnItemEx("SamsaraDoomguyStrBFGBallImprovedCoopSoundDE",0,0,32,25,0,0,15)
        stop
    }
}

actor SamsaraDoomguyStrBFG9000PreFireSoundPlayer : Trigger
{
    States
    {
      // Sound playing stuff
      Pickup:
        TNT1 A 0 A_JumpIfInventory("SamsaraAlternateSoundToken",1,"PickupDE")
      PickupStr:
        TNT1 A 0 A_PlaySound("doomguy/stronghold/bfgf",CHAN_WEAPON)
        stop

      PickupDE:
        TNT1 A 0 A_PlaySound("doomguy/demoneclipse/bfgf",CHAN_WEAPON)
        stop
    }
}

// Powered attack handler

actor SamsaraDoomguyStrBFG9000PoweredAttackHandler : Trigger
{
    States
    {
      // Ammo checking/taking stuff
      Pickup:
        TNT1 A 0 A_JumpIfInventory("SamsaraHasInfiniteAmmo",1,"PickupAttack")
        TNT1 A 0 A_JumpIfInventory("Cell",5,1)
        stop
        TNT1 A 0 A_TakeInventory("Cell",5)
        goto PickupAttack

      // Attack stuff
      PickupAttack:
        TNT1 A 0 A_JumpIfInventory("DoomNoBFGAim",1,"PickupAttackNoAim")
        TNT1 A 0 A_JumpIfInventory("SPModeOn",1,"PickupAttackCoop")
        TNT1 A 0 A_JumpIfInventory("CoopModeOn",1,"PickupAttackCoop")
        TNT1 A 0 A_JumpIfInventory("SamsaraAlternateSoundToken",1,"PickupAttackDMSoundDE")
      PickupAttackDM:
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyStrPowerBFGBall",0,false)
        stop

      PickupAttackDMSoundDE:
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyStrPowerBFGBallSoundDE",0,false)
        stop

      PickupAttackCoop:
        TNT1 A 0 A_JumpIfInventory("SamsaraAlternateSoundToken",1,"PickupAttackCoopSoundDE")
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyStrPowerBFGBallCoop",0,false)
        stop

      PickupAttackCoopSoundDE:
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyStrPowerBFGBallCoopSoundDE",0,false)
        stop

      // No aiming attack stuff
      PickupAttackNoAim:
        TNT1 A 0 A_JumpIfInventory("SPModeOn",1,"PickupAttackNoAimCoop")
        TNT1 A 0 A_JumpIfInventory("CoopModeOn",1,"PickupAttackNoAimCoop")
        TNT1 A 0 A_JumpIfInventory("SamsaraAlternateSoundToken",1,"PickupAttackNoAimDMSoundDE")
      PickupAttackNoAimDM:
        TNT1 A 0 A_SpawnItemEx("SamsaraDoomguyStrPowerBFGBallNoAim",0,0,32,25)
        TNT1 A 0 A_JumpIfInventory("SamsaraHasSpread",1,1)
        stop
        TNT1 A 0 A_SpawnItemEx("SamsaraDoomguyStrPowerBFGBallNoAim",0,0,32,25,0,0,-15)
        TNT1 A 0 A_SpawnItemEx("SamsaraDoomguyStrPowerBFGBallNoAim",0,0,32,25,0,0,15)
        stop

      PickupAttackNoAimDMSoundDE:
        TNT1 A 0 A_SpawnItemEx("SamsaraDoomguyStrPowerBFGBallNoAimSoundDE",0,0,32,25)
        TNT1 A 0 A_JumpIfInventory("SamsaraHasSpread",1,1)
        stop
        TNT1 A 0 A_SpawnItemEx("SamsaraDoomguyStrPowerBFGBallNoAimSoundDE",0,0,32,25,0,0,-15)
        TNT1 A 0 A_SpawnItemEx("SamsaraDoomguyStrPowerBFGBallNoAimSoundDE",0,0,32,25,0,0,15)
        stop

      PickupAttackNoAimCoop:
        TNT1 A 0 A_JumpIfInventory("SamsaraAlternateSoundToken",1,"PickupAttackNoAimCoopSoundDE")
        TNT1 A 0 A_SpawnItemEx("SamsaraDoomguyStrPowerBFGBallNoAimCoop",0,0,32,25)
        TNT1 A 0 A_JumpIfInventory("SamsaraHasSpread",1,1)
        stop
        TNT1 A 0 A_SpawnItemEx("SamsaraDoomguyStrPowerBFGBallNoAimCoop",0,0,32,25,0,0,-15)
        TNT1 A 0 A_SpawnItemEx("SamsaraDoomguyStrPowerBFGBallNoAimCoop",0,0,32,25,0,0,15)
        stop

      PickupAttackNoAimCoopSoundDE:
        TNT1 A 0 A_SpawnItemEx("SamsaraDoomguyStrPowerBFGBallNoAimCoopSoundDE",0,0,32,25)
        TNT1 A 0 A_JumpIfInventory("SamsaraHasSpread",1,1)
        stop
        TNT1 A 0 A_SpawnItemEx("SamsaraDoomguyStrPowerBFGBallNoAimCoopSoundDE",0,0,32,25,0,0,-15)
        TNT1 A 0 A_SpawnItemEx("SamsaraDoomguyStrPowerBFGBallNoAimCoopSoundDE",0,0,32,25,0,0,15)
        stop
    }
}

// BFG ball

actor SamsaraDoomguyStrBFGBall : BFGBall
{
	DamageType "DoomDamageTypeBFG"
	DeathSound "doomguy/stronghold/bfgx"
	Decal "DoomBFGLightning"
	-BLOODSPLATTER
	+DONTREFLECT
	States
	{
	Spawn:
		DBFS CD 4 Bright Light("BFGBALL")
		loop

	Death:
		DBFE G 8 Bright Light("BFGBALL_X1")
		DBFE H 8 Bright Light("BFGBALL_X2")
		TNT1 A 0 A_BFGSpray("SamsaraDoomguyStrBFGExtra")
	DeathFinish:
		DBFE I 8 Bright Light("BFGBALL_X3")
		DBFE J 8 Bright Light("BFGBALL_X1")
		DBFE K 8 Bright Light("BFGBALL_X4")
		DBFE L 8 Bright Light("BFGBALL_X5")
		stop
	}
}

actor SamsaraDoomguyStrBFGBallCoop : SamsaraDoomguyStrBFGBall
{
	Species "Player"
	+THRUSPECIES
	States
	{
	Death:
		DBFE G 8 Bright Light("BFGBALL_X1")
		DBFE H 8 Bright Light("BFGBALL_X2")
		TNT1 A 0 A_BFGSpray("SamsaraDoomguyStrBFGExtraCoop")
		goto DeathFinish
	}
}

actor SamsaraDoomguyStrBFGBallSoundDE : SamsaraDoomguyStrBFGBall { DeathSound "doomguy/demoneclipse/bfgx" }

actor SamsaraDoomguyStrBFGBallCoopSoundDE : SamsaraDoomguyStrBFGBallSoundDE
{
	Species "Player"
	+THRUSPECIES
	States
	{
	Death:
		DBFE G 8 Bright Light("BFGBALL_X1")
		DBFE H 8 Bright Light("BFGBALL_X2")
		TNT1 A 0 A_BFGSpray("SamsaraDoomguyStrBFGExtraCoop")
		goto DeathFinish
	}
}

actor SamsaraDoomguyStrBFGBallImproved : SamsaraDoomguyStrBFGBall
{
	+FORCERADIUSDMG
	States
	{
	Death:
		DBFE G 8 Bright Light("BFGBALL_X1") //A_BFGSpray("SamsaraDoomguyStrBFGExtra",40,8)
		DBFE H 8 Bright Light("BFGBALL_X2") //A_Explode(128,256,0)
		TNT1 A 0 A_BFGSpray("SamsaraDoomguyStrBFGExtra",40,16)
		goto DeathFinish
	}
}

actor SamsaraDoomguyStrBFGBallImprovedCoop : SamsaraDoomguyStrBFGBallImproved
{
	Species "Player"
	+THRUSPECIES
	States
	{
	Death:
		DBFE G 8 Bright Light("BFGBALL_X1") //A_BFGSpray("SamsaraDoomguyStrBFGExtraCoop",40,8)
		DBFE H 8 Bright Light("BFGBALL_X2") //A_Explode(128,256,0)
		TNT1 A 0 A_BFGSpray("SamsaraDoomguyStrBFGExtraCoop",40,16)
		goto DeathFinish
	}
}

actor SamsaraDoomguyStrBFGBallImprovedSoundDE : SamsaraDoomguyStrBFGBallImproved { DeathSound "doomguy/demoneclipse/bfgx" }

actor SamsaraDoomguyStrBFGBallImprovedCoopSoundDE : SamsaraDoomguyStrBFGBallImprovedSoundDE
{
	Species "Player"
	+THRUSPECIES
	States
	{
	Death:
		DBFE G 8 Bright Light("BFGBALL_X1") //A_BFGSpray("SamsaraDoomguyStrBFGExtraCoop",40,8)
		DBFE H 8 Bright Light("BFGBALL_X2") //A_Explode(128,256,0)
		TNT1 A 0 A_BFGSpray("SamsaraDoomguyStrBFGExtraCoop",40,16)
		goto DeathFinish
	}
}

// BFG tracer

actor SamsaraDoomguyStrBFGExtra : BFGExtra
{
	DamageType "DoomDamageTypeBFG"
	States
	{
	Spawn:
		DBFP E 8 Bright Light("BFGBALL")
		DBFP F 8 Bright Light("BFGBALL_X1")
		DBFP G 8 Bright Light("BFGBALL_X4")
		DBFP H 8 Bright Light("BFGBALL_X5")
		stop
	}
}

actor SamsaraDoomguyStrBFGExtraCoop : SamsaraDoomguyStrBFGExtra { +MTHRUSPECIES }

// Powered BFG ball

actor SamsaraDoomguyStrPowerBFGBall : SamsaraDoomguyStrBFGBall
{
	Speed 35
	Damage 20
	DamageType "DoomDamageTypeBFGNoSelfDamage"
	Scale 0.6
	SeeSound "doomguy/stronghold/powerbfgfire"
	DeathSound "doomguy/stronghold/powerbfgexplode"
	Decal "DoomBFGScorch"
	//SelfObituary "%o couldn't handle the overwhelming power."
	+EXTREMEDEATH
	+FORCERADIUSDMG
	States
	{
	Spawn:
		DBFS CD 4 Bright Light("BFGBALLp")
		loop

	Death:
/*
		TNT1 A 0 A_GiveToTarget("SamsaraDoomguyNoSelfDamage")
		TNT1 A 0 A_Explode(96,144)
		TNT1 A 0 A_TakeFromTarget("PowerSamsaraDoomguyNoSelfDamage")
		TNT1 A 0 A_Explode(96,288,0)
		TNT1 A 0 A_BFGSpray("SamsaraDoomguyStrBFGExtra",20,12)
*/
		TNT1 A 0 A_Explode(128,192)
	DeathFinish:
		DBFE G 3 Bright Light("BFGBALL_X1p")
		DBFE H 3 Bright Light("BFGBALL_X2p")
		DBFE I 3 Bright Light("BFGBALL_X3p")
		DBFE J 3 Bright Light("BFGBALL_X1p")
		DBFE K 3 Bright Light("BFGBALL_X4p")
		DBFE L 3 Bright Light("BFGBALL_X5p")
		stop
	}
}

actor SamsaraDoomguyStrPowerBFGBallCoop : SamsaraDoomguyStrPowerBFGBall
{
	Species "Player"
	+THRUSPECIES
}

actor SamsaraDoomguyStrPowerBFGBallSoundDE : SamsaraDoomguyStrPowerBFGBall
{
	SeeSound "doomguy/demoneclipse/powerbfgfire"
	DeathSound "doomguy/demoneclipse/powerbfgexplode"
}

actor SamsaraDoomguyStrPowerBFGBallCoopSoundDE : SamsaraDoomguyStrPowerBFGBallSoundDE
{
	Species "Player"
	+THRUSPECIES
	States
	{
	Death:
		TNT1 A 0 A_Explode(128,192)
		goto DeathFinish
	}
}

actor SamsaraDoomguyStrPowerBFGBallNoAim : SamsaraDoomguyStrPowerBFGBall
{
	SeeSound ""
	DeathSound ""
	+NOTIMEFREEZE
	States
	{
	Spawn:
		DBFS C 0 Bright NoDelay Light("BFGBALLp") A_PlaySound("doomguy/stronghold/powerbfgfire",CHAN_VOICE)
		TNT1 A 0 A_GiveInventory("SamsaraProjectileSpawnInit")
		TNT1 A 0 A_ChangeFlag("NOTIMEFREEZE",false)
		goto Super::Spawn

	Death:
		TNT1 A 0 A_JumpIfInventory("SamsaraProjectileSpawnInit",1,"DeathStart")
		TNT1 A 0 A_PlaySound("doomguy/stronghold/powerbfgfire",CHAN_VOICE)
		TNT1 A 0 A_GiveInventory("SamsaraProjectileSpawnInit")
	DeathStart:
		TNT1 A 0 A_PlaySound("doomguy/stronghold/powerbfgexplode",CHAN_VOICE)
		TNT1 A 0 A_Explode(128,192)
		TNT1 A 0 A_ChangeFlag("NOTIMEFREEZE",false)
		goto DeathFinish
	}
}

actor SamsaraDoomguyStrPowerBFGBallNoAimCoop : SamsaraDoomguyStrPowerBFGBallNoAim
{
	Species "Player"
	+THRUSPECIES
	States
	{
	Death:
		TNT1 A 0 A_JumpIfInventory("SamsaraProjectileSpawnInit",1,"DeathStart")
		TNT1 A 0 A_PlaySound("doomguy/stronghold/powerbfgfire",CHAN_VOICE)
		TNT1 A 0 A_GiveInventory("SamsaraProjectileSpawnInit")
	DeathStart:
		TNT1 A 0 A_PlaySound("doomguy/stronghold/powerbfgexplode",CHAN_VOICE)
		TNT1 A 0 A_Explode(128,192)
		TNT1 A 0 A_ChangeFlag("NOTIMEFREEZE",false)
		goto DeathFinish
	}
}

actor SamsaraDoomguyStrPowerBFGBallNoAimSoundDE : SamsaraDoomguyStrPowerBFGBallNoAim
{
	States
	{
	Spawn:
		DBFS C 0 Bright NoDelay Light("BFGBALLp") A_PlaySound("doomguy/demoneclipse/powerbfgfire",CHAN_VOICE)
		TNT1 A 0 A_GiveInventory("SamsaraProjectileSpawnInit")
		TNT1 A 0 A_ChangeFlag("NOTIMEFREEZE",false)
		goto SamsaraDoomguyStrPowerBFGBall::Spawn

	Death:
		TNT1 A 0 A_JumpIfInventory("SamsaraProjectileSpawnInit",1,"DeathStart")
		TNT1 A 0 A_PlaySound("doomguy/demoneclipse/powerbfgfire",CHAN_VOICE)
		TNT1 A 0 A_GiveInventory("SamsaraProjectileSpawnInit")
	DeathStart:
		TNT1 A 0 A_PlaySound("doomguy/demoneclipse/powerbfgexplode",CHAN_VOICE)
		TNT1 A 0 A_Explode(128,192)
		TNT1 A 0 A_ChangeFlag("NOTIMEFREEZE",false)
		goto DeathFinish
	}
}

actor SamsaraDoomguyStrPowerBFGBallNoAimCoopSoundDE : SamsaraDoomguyStrPowerBFGBallNoAimSoundDE
{
	Species "Player"
	+THRUSPECIES
	States
	{
	Death:
		TNT1 A 0 A_JumpIfInventory("SamsaraProjectileSpawnInit",1,"DeathStart")
		TNT1 A 0 A_PlaySound("doomguy/demoneclipse/powerbfgfire",CHAN_VOICE)
		TNT1 A 0 A_GiveInventory("SamsaraProjectileSpawnInit")
	DeathStart:
		TNT1 A 0 A_PlaySound("doomguy/demoneclipse/powerbfgexplode",CHAN_VOICE)
		TNT1 A 0 A_Explode(128,192)
		TNT1 A 0 A_ChangeFlag("NOTIMEFREEZE",false)
		goto DeathFinish
	}
}

// B.F.G. 2704

actor "B.F.G. 2704" : BFG9000
{
	//Weapon.SlotNumber 7
	Weapon.SlotPriority 1
	Weapon.AmmoGive 0 // 40
	Obituary "$SAMSARA_DOOMGUY_OB_SLOT7_1"
	Inventory.RestrictedTo "DoomguyPlayer"
	Tag "B.F.G. 2704"
	+UNDROPPABLE
	+WEAPON.BFG
	States
	{
	Spawn:
		DBXB M -1
		stop

	Ready:
		DBXB P 1 A_WeaponReady
		loop

	Deselect:
		DBXB P 1 A_Lower
		loop

	Select:
		DBXB P 1 A_Raise
		loop

	Fire:
		TNT1 A 0 A_GiveInventory("SamsaraDoomguyBFG9000PreFireSoundPlayer")
		TNT1 A 0 A_JumpIfInventory("SamsaraUsingSmoothAnims",1,"FireSmooth")
	FireVanilla:
		DBXB P 10 A_JumpIfInventory("SamsaraHasDoubleFiringSpeed",1,"FireVanillaRage")
		DBXB Q 0 Bright A_GunFlash
		DBXB QQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQ 1 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 20 A_ReFire
		goto Ready

	FireVanillaRage:
		DBXB P 10
		DBXB Q 0 Bright
		DBXB Q 0 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 1 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 0 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 1 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 0 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 1 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 0 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 1 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 0 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 1 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 0 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 1 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 0 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 1 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 0 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 1 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 0 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 1 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 0 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 1 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 0 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 1 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 0 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 1 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 0 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 1 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 0 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 1 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 0 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 1 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 0 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 1 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 0 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 1 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 0 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 1 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 0 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 1 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 0 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 1 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 20 A_ReFire
		goto Ready

	FireSmooth:
		DBXB P 10 A_JumpIfInventory("SamsaraHasDoubleFiringSpeed",1,"FireSmoothRage")
		DBXB Q 0 Bright A_GunFlash("FlashSmooth")
		DBXB QQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQ 1 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 2 A_ReFire
		DBXB O 2
		DBXB O 2 offset(0,31)
		DBXB O 2 offset(0,30)
		DBXB O 2 offset(0,29)
		DBXB N 2 offset(0,28)
		DBXB N 2 offset(0,27)
		DBXB P 2 offset(0,28)
		DBXB P 2 offset(0,30)
		DBXB P 2 offset(0,32)
		goto Ready

	FireSmoothRage:
		DBXB P 10
		DBXB Q 0 Bright A_GunFlash("FlashSmoothRage")
		DBXB Q 0 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 1 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 0 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 1 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 0 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 1 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 0 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 1 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 0 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 1 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 0 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 1 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 0 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 1 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 0 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 1 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 0 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 1 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 0 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 1 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 0 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 1 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 0 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 1 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 0 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 1 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 0 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 1 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 0 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 1 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 0 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 1 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 0 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 1 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 0 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 1 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 0 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 1 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 0 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 1 Bright A_GiveInventory("SamsaraDoomguyBFG2704AttackHandler")
		DBXB Q 2 A_ReFire
		DBXB O 2
		DBXB O 2 offset(0,31)
		DBXB O 2 offset(0,30)
		DBXB O 2 offset(0,29)
		DBXB N 2 offset(0,28)
		DBXB N 2 offset(0,27)
		DBXB P 2 offset(0,28)
		DBXB P 2 offset(0,30)
		DBXB P 2 offset(0,32)
		goto Ready

	Flash:
		DBXB RSRSRSRSRS 4 bright A_Light2
		goto LightDone

	FlashSmooth:
		DBXB RSRSRSRSRSRSRSRSRSRSRSRSRSRSRSRSRSRSRSRS 1 bright A_Light2
		goto LightDone

	FlashSmoothRage:
		DBXB RSRSRSRSRSRSRSRSRSRS 1 bright A_Light2
		goto LightDone
	}
}

actor SamsaraDoomguyBFG2704AttackHandler : Trigger
{
    States
    {
      // Ammo checking/taking stuff
      Pickup:
        TNT1 A 0 A_JumpIfInventory("SamsaraHasInfiniteAmmo",1,"PickupAttack")
        TNT1 A 0 A_JumpIfInventory("Cell",1,1)
        stop
        TNT1 A 0 A_TakeInventory("Cell",1)
        goto PickupAttack

      // Attack stuff
      PickupAttack:
        TNT1 A 0 A_JumpIfInventory("SamsaraImprovedDoomguyBalance",1,"PickupAttackImproved")
      // Vanilla
      PickupAttackVanilla:
        TNT1 A 0 A_JumpIfInventory("SPModeOn",1,"PickupAttackVanillaCoop")
        TNT1 A 0 A_JumpIfInventory("CoopModeOn",1,"PickupAttackVanillaCoop")
        TNT1 A 0 A_JumpIfInventory("SamsaraAlternateSoundToken",2,"PickupAttackVanillaDMSoundPerkristan")
        TNT1 A 0 A_JumpIfInventory("SamsaraAlternateSoundToken",1,"PickupAttackVanillaDMSoundPSX")
      PickupAttackVanillaDM:
        TNT1 A 0 A_Jump(256,1,3,5)
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall1Vanilla",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall1Vanilla",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        stop
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall1Vanilla",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall2Vanilla",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        stop
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall2Vanilla",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall2Vanilla",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        stop

      PickupAttackVanillaDMSoundPSX:
        TNT1 A 0 A_Jump(256,1,3,5)
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall1VanillaSoundPSX",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall1VanillaSoundPSX",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        stop
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall1VanillaSoundPSX",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall2VanillaSoundPSX",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        stop
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall2VanillaSoundPSX",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall2VanillaSoundPSX",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        stop

      PickupAttackVanillaDMSoundPerkristan:
        TNT1 A 0 A_Jump(256,1,3,5)
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall1VanillaSoundPerkristan",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall1VanillaSoundPerkristan",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        stop
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall1VanillaSoundPerkristan",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall2VanillaSoundPerkristan",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        stop
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall2VanillaSoundPerkristan",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall2VanillaSoundPerkristan",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        stop

      PickupAttackVanillaCoop:
        TNT1 A 0 A_JumpIfInventory("SamsaraAlternateSoundToken",2,"PickupAttackVanillaCoopSoundPerkristan")
        TNT1 A 0 A_JumpIfInventory("SamsaraAlternateSoundToken",1,"PickupAttackVanillaCoopSoundPSX")
        TNT1 A 0 A_Jump(256,1,3,5)
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall1VanillaCoop",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall1VanillaCoop",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        stop
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall1VanillaCoop",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall2VanillaCoop",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        stop
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall2VanillaCoop",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall2VanillaCoop",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        stop

      PickupAttackVanillaCoopSoundPSX:
        TNT1 A 0 A_Jump(256,1,3,5)
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall1VanillaCoopSoundPSX",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall1VanillaCoopSoundPSX",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        stop
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall1VanillaCoopSoundPSX",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall2VanillaCoopSoundPSX",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        stop
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall2VanillaCoopSoundPSX",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall2VanillaCoopSoundPSX",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        stop

      PickupAttackVanillaCoopSoundPerkristan:
        TNT1 A 0 A_Jump(256,1,3,5)
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall1VanillaCoopSoundPerkristan",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall1VanillaCoopSoundPerkristan",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        stop
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall1VanillaCoopSoundPerkristan",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall2VanillaCoopSoundPerkristan",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        stop
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall2VanillaCoopSoundPerkristan",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall2VanillaCoopSoundPerkristan",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        stop

      // Improved
      PickupAttackImproved:
        TNT1 A 0 A_JumpIfInventory("SPModeOn",1,"PickupAttackImprovedCoop")
        TNT1 A 0 A_JumpIfInventory("CoopModeOn",1,"PickupAttackImprovedCoop")
        TNT1 A 0 A_JumpIfInventory("SamsaraAlternateSoundToken",2,"PickupAttackImprovedDMSoundPerkristan")
        TNT1 A 0 A_JumpIfInventory("SamsaraAlternateSoundToken",1,"PickupAttackImprovedDMSoundPSX")
      PickupAttackImprovedDM:
        TNT1 A 0 A_Jump(256,1,3,5)
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall1",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall1",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        stop
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall1",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall2",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        stop
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall2",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall2",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        stop

      PickupAttackImprovedDMSoundPSX:
        TNT1 A 0 A_Jump(256,1,3,5)
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall1SoundPSX",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall1SoundPSX",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        stop
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall1SoundPSX",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall2SoundPSX",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        stop
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall2SoundPSX",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall2SoundPSX",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        stop

      PickupAttackImprovedDMSoundPerkristan:
        TNT1 A 0 A_Jump(256,1,3,5)
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall1SoundPerkristan",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall1SoundPerkristan",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        stop
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall1SoundPerkristan",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall2SoundPerkristan",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        stop
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall2SoundPerkristan",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall2SoundPerkristan",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        stop

      PickupAttackImprovedCoop:
        TNT1 A 0 A_JumpIfInventory("SamsaraAlternateSoundToken",2,"PickupAttackImprovedCoopSoundPerkristan")
        TNT1 A 0 A_JumpIfInventory("SamsaraAlternateSoundToken",1,"PickupAttackImprovedCoopSoundPSX")
        TNT1 A 0 A_Jump(256,1,3,5)
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall1Coop",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall1Coop",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        stop
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall1Coop",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall2Coop",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        stop
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall2Coop",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall2Coop",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        stop

      PickupAttackImprovedCoopSoundPSX:
        TNT1 A 0 A_Jump(256,1,3,5)
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall1CoopSoundPSX",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall1CoopSoundPSX",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        stop
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall1CoopSoundPSX",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall2CoopSoundPSX",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        stop
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall2CoopSoundPSX",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall2CoopSoundPSX",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        stop

      PickupAttackImprovedCoopSoundPerkristan:
        TNT1 A 0 A_Jump(256,1,3,5)
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall1CoopSoundPerkristan",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall1CoopSoundPerkristan",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        stop
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall1CoopSoundPerkristan",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall2CoopSoundPerkristan",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        stop
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall2CoopSoundPerkristan",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        TNT1 A 0 A_FireCustomMissile("DoomBFGPlasmaBall2CoopSoundPerkristan",frandom(-7.7,7.7),false,0,0,0,frandom(-8.9,8.9))
        stop
    }
}

actor DoomBFGPlasmaBall1 : PlasmaBall
{
	Damage (44)
	BounceType "Classic"
	BounceFactor 1.0
	Decal DoomBFGGreenPlasmaScorch
	SeeSound ""
	DeathSound "doomguy/plasmax"
	Obituary "$SAMSARA_DOOMGUY_OB_SLOT7_LOADOUT1"
	DamageType "DoomDamageTypeBFG"
	-BLOODSPLATTER
	States
	{
	Spawn:
		DBXB AB 6 bright
		loop
	Death:
		DBXB C 4 bright A_Explode(96,96,0)
		DBXB DEFG 4 bright
		stop
	}
}

actor DoomBFGPlasmaBall2 : DoomBFGPlasmaBall1
{
	Decal DoomBFGRedPlasmaScorch
	States
	{
	Spawn:
		DBXB HI 6 bright
		Loop
	Death:
		DBXB J 4 bright A_Explode(96,96,0)
		DBXB KL 4 bright
		Stop
	}
}

actor DoomBFGPlasmaBall1Vanilla : DoomBFGPlasmaBall1
{ 
	Damage 8
	States
	{
	Death:
		DBXB C 4 bright A_Explode(64,96,0)
		DBXB DEFG 4 bright
		stop
	}
}

actor DoomBFGPlasmaBall2Vanilla : DoomBFGPlasmaBall2
{ 
	Damage 8
	States
	{
	Death:
		DBXB J 4 bright A_Explode(64,96,0)
		DBXB KL 4 bright
		Stop
	}
}

actor DoomBFGPlasmaBall1Coop : DoomBFGPlasmaBall1 { +THRUSPECIES Species "Player" }
actor DoomBFGPlasmaBall2Coop : DoomBFGPlasmaBall2 { +THRUSPECIES Species "Player" }
actor DoomBFGPlasmaBall1VanillaCoop : DoomBFGPlasmaBall1Vanilla { +THRUSPECIES Species "Player" }
actor DoomBFGPlasmaBall2VanillaCoop : DoomBFGPlasmaBall2Vanilla { +THRUSPECIES Species "Player" }

actor DoomBFGPlasmaBall1SoundPSX : DoomBFGPlasmaBall1 { DeathSound "doom64guy/plasmax" }
actor DoomBFGPlasmaBall2SoundPSX : DoomBFGPlasmaBall2 { DeathSound "doom64guy/plasmax" }
actor DoomBFGPlasmaBall1VanillaSoundPSX : DoomBFGPlasmaBall1Vanilla { DeathSound "doom64guy/plasmax" }
actor DoomBFGPlasmaBall2VanillaSoundPSX : DoomBFGPlasmaBall2Vanilla { DeathSound "doom64guy/plasmax" }
actor DoomBFGPlasmaBall1CoopSoundPSX : DoomBFGPlasmaBall1SoundPSX { +THRUSPECIES Species "Player" }
actor DoomBFGPlasmaBall2CoopSoundPSX : DoomBFGPlasmaBall2SoundPSX { +THRUSPECIES Species "Player" }
actor DoomBFGPlasmaBall1VanillaCoopSoundPSX : DoomBFGPlasmaBall1VanillaSoundPSX { +THRUSPECIES Species "Player" }
actor DoomBFGPlasmaBall2VanillaCoopSoundPSX : DoomBFGPlasmaBall2VanillaSoundPSX { +THRUSPECIES Species "Player" }

actor DoomBFGPlasmaBall1SoundPerkristan : DoomBFGPlasmaBall1 { DeathSound "doomguy/perkristan/plasmax" }
actor DoomBFGPlasmaBall2SoundPerkristan : DoomBFGPlasmaBall2 { DeathSound "doomguy/perkristan/plasmax" }
actor DoomBFGPlasmaBall1VanillaSoundPerkristan : DoomBFGPlasmaBall1Vanilla { DeathSound "doomguy/perkristan/plasmax" }
actor DoomBFGPlasmaBall2VanillaSoundPerkristan : DoomBFGPlasmaBall2Vanilla { DeathSound "doomguy/perkristan/plasmax" }
actor DoomBFGPlasmaBall1CoopSoundPerkristan : DoomBFGPlasmaBall1SoundPerkristan { +THRUSPECIES Species "Player" }
actor DoomBFGPlasmaBall2CoopSoundPerkristan : DoomBFGPlasmaBall2SoundPerkristan { +THRUSPECIES Species "Player" }
actor DoomBFGPlasmaBall1VanillaCoopSoundPerkristan : DoomBFGPlasmaBall1VanillaSoundPerkristan { +THRUSPECIES Species "Player" }
actor DoomBFGPlasmaBall2VanillaCoopSoundPerkristan : DoomBFGPlasmaBall2VanillaSoundPerkristan { +THRUSPECIES Species "Player" }

// Calamity Blade

actor SamsaraDoomguyCalamityBladeCharge : Counter { Inventory.MaxAmount 5 }

actor "Calamity Blade" : Weapon
{
    Weapon.SelectionOrder 1000
    Weapon.AmmoUse 20 // ammo use doubled due to running off cells
    Weapon.AmmoType "Cell"
    //Weapon.SlotNumber 7
    Weapon.SlotPriority 1
    Tag "Calamity Blade"
    Inventory.PickupMessage "You got the Calamity Blade!"
    +BFG
    +NOAUTOAIM
    +UNDROPPABLE
    Inventory.RestrictedTo "DoomguyPlayer"
    States
    {
      Spawn:
        WCBL A -1
        stop

      Ready:
        TNT1 A 0 A_TakeInventory("SamsaraDoomguyCalamityBladeCharge")
        DHTG A 1 A_WeaponReady
        loop

      Deselect:
        TNT1 A 0 A_TakeInventory("SamsaraDoomguyCalamityBladeCharge")
        DHTG A 1 A_Lower
        loop

      Select:
        TNT1 A 0 A_TakeInventory("SamsaraDoomguyCalamityBladeCharge")
        DHTG A 1 A_Raise
        loop

      Fire:
        TNT1 A 0 A_JumpIfInventory("SamsaraDoomguyCalamityBladeCharge",4,8)
        TNT1 A 0 A_JumpIfInventory("SamsaraDoomguyCalamityBladeCharge",3,6)
        TNT1 A 0 A_JumpIfInventory("SamsaraDoomguyCalamityBladeCharge",2,4)
        TNT1 A 0 A_JumpIfInventory("SamsaraDoomguyCalamityBladeCharge",1,2)
        TNT1 A 0 A_GunFlash("FlashCharge1",GFF_NOEXTCHANGE)
        goto FireCharge
        TNT1 A 0 A_GunFlash("FlashCharge2",GFF_NOEXTCHANGE)
        goto FireCharge
        TNT1 A 0 A_GunFlash("FlashCharge3",GFF_NOEXTCHANGE)
        goto FireCharge
        TNT1 A 0 A_GunFlash("FlashCharge4",GFF_NOEXTCHANGE)
        goto FireCharge
        TNT1 A 0 A_GunFlash("FlashCharge5",GFF_NOEXTCHANGE)
        goto FireCharge

      FireCharge:
        DHTG A 20 A_GiveInventory("SamsaraDoomguyCalamityBladeChargeGiver")
        TNT1 A 0 A_JumpIfInventory("SamsaraDoomguyCalamityBladeCharge",0,"FireStart")
        TNT1 A 0 A_JumpIfInventory("SamsaraHasInfiniteAmmo",1,2)
        TNT1 A 0 A_JumpIfInventory("Cell",20,1)
        goto FireStart
        TNT1 A 0 A_ReFire // still changes player sprite due to limitations
        goto FireStart

      FlashCharge1:
        DHTC A 6 Bright
        DHTC BCD 5 Bright
        stop

      FlashCharge2:
        DHTC E 6 Bright
        DHTC FGH 5 Bright
        stop

      FlashCharge3:
        DHTC I 6 Bright
        DHTC JKL 5 Bright
        stop

      FlashCharge4:
        DHTC M 6 Bright
        DHTC NOP 5 Bright
        stop

      FlashCharge5:
        DHTC Q 6 Bright
        DHTC RST 5 Bright
        stop

      FireStart:
        TNT1 A 0 A_GunFlash
        DHTF A 3 Bright A_GiveInventory("SamsaraDoomguyCalamityBladeAttackHandler")
        DHTF B 5 Bright
        DHTG DCB 4
        TNT1 A 0 A_ReFire
        goto Ready

      Flash:
        TNT1 A 3 A_Light1
        TNT1 A 5 A_Light2
        goto LightDone
    }
}

actor SamsaraDoomguyCalamityBladeChargeGiver : Trigger
{
    States
    {
      // Ammo checking/taking stuff
      Pickup:
        TNT1 A 0 A_JumpIfInventory("SamsaraDoomguyCalamityBladeCharge",0,"PickupStop")
        TNT1 A 0 A_JumpIfInventory("SamsaraHasInfiniteAmmo",1,"PickupGiveCharge")
        TNT1 A 0 A_JumpIfInventory("Cell",20,1)
        stop
        TNT1 A 0 A_TakeInventory("Cell",20)
        goto PickupGiveCharge

      // Charge giving stuff
      PickupGiveCharge:
        TNT1 A 0 A_PlaySound("doomguy/calamityblade/charge",CHAN_WEAPON)
        TNT1 A 0 A_GiveInventory("SamsaraDoomguyCalamityBladeCharge")
        stop
    }
}

actor SamsaraDoomguyCalamityBladeAttackHandler : Trigger
{
    States
    {
      // Charge checking/taking stuff
      Pickup:
        TNT1 A 0 A_JumpIfInventory("SamsaraDoomguyCalamityBladeCharge",1,"PickupAttack")
        stop

      // Attack stuff
      PickupAttack:
        TNT1 A 0 A_PlaySound("doomguy/calamityblade/shoot",CHAN_WEAPON)
        TNT1 A 0 A_JumpIfInventory("SamsaraDoomguyCalamityBladeCharge",0,"PickupAttackLevel5")
        TNT1 A 0 A_JumpIfInventory("SamsaraDoomguyCalamityBladeCharge",4,"PickupAttackLevel4")
        TNT1 A 0 A_JumpIfInventory("SamsaraDoomguyCalamityBladeCharge",3,"PickupAttackLevel3")
        TNT1 A 0 A_JumpIfInventory("SamsaraDoomguyCalamityBladeCharge",2,"PickupAttackLevel2")
      // Level 1
      PickupAttackLevel1:
        TNT1 A 0 A_JumpIfInventory("SPModeOn",1,"PickupAttackLevel1Coop")
        TNT1 A 0 A_JumpIfInventory("CoopModeOn",1,"PickupAttackLevel1Coop")
      PickupAttackLevel1DM:
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectile",-5,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectile",0,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectile",5,false)
        goto PickupFinish

      PickupAttackLevel1Coop:
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectileCoop",-5,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectileCoop",0,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectileCoop",5,false)
        goto PickupFinish

      // Level 2
      PickupAttackLevel2:
        TNT1 A 0 A_JumpIfInventory("SPModeOn",1,"PickupAttackLevel2Coop")
        TNT1 A 0 A_JumpIfInventory("CoopModeOn",1,"PickupAttackLevel2Coop")
      PickupAttackLevel2DM:
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectile",-12.5,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectile",-7.5,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectile",-2.5,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectile",2.5,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectile",7.5,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectile",12.5,false)
        goto PickupFinish

      PickupAttackLevel2Coop:
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectileCoop",-12.5,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectileCoop",-7.5,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectileCoop",-2.5,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectileCoop",2.5,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectileCoop",7.5,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectileCoop",12.5,false)
        goto PickupFinish

      // Level 3
      PickupAttackLevel3:
        TNT1 A 0 A_JumpIfInventory("SPModeOn",1,"PickupAttackLevel3Coop")
        TNT1 A 0 A_JumpIfInventory("CoopModeOn",1,"PickupAttackLevel3Coop")
      PickupAttackLevel3DM:
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectile",-20,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectile",-15,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectile",-10,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectile",-5,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectile",0,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectile",5,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectile",10,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectile",15,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectile",20,false)
        goto PickupFinish

      PickupAttackLevel3Coop:
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectileCoop",-20,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectileCoop",-15,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectileCoop",-10,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectileCoop",-5,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectileCoop",0,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectileCoop",5,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectileCoop",10,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectileCoop",15,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectileCoop",20,false)
        goto PickupFinish

      // Level 4
      PickupAttackLevel4:
        TNT1 A 0 A_JumpIfInventory("SPModeOn",1,"PickupAttackLevel4Coop")
        TNT1 A 0 A_JumpIfInventory("CoopModeOn",1,"PickupAttackLevel4Coop")
      PickupAttackLevel4DM:
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectile",-27.5,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectile",-22.5,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectile",-17.5,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectile",-12.5,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectile",-7.5,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectile",-2.5,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectile",2.5,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectile",7.5,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectile",12.5,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectile",17.5,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectile",22.5,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectile",27.5,false)
        goto PickupFinish

      PickupAttackLevel4Coop:
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectileCoop",-27.5,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectileCoop",-22.5,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectileCoop",-17.5,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectileCoop",-12.5,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectileCoop",-7.5,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectileCoop",-2.5,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectileCoop",2.5,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectileCoop",7.5,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectileCoop",12.5,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectileCoop",17.5,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectileCoop",22.5,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectileCoop",27.5,false)
        goto PickupFinish

      // Level 5
      PickupAttackLevel5:
        TNT1 A 0 A_JumpIfInventory("SPModeOn",1,"PickupAttackLevel5Coop")
        TNT1 A 0 A_JumpIfInventory("CoopModeOn",1,"PickupAttackLevel5Coop")
      PickupAttackLevel5DM:
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectile",-35,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectile",-30,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectile",-25,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectile",-20,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectile",-15,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectile",-10,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectile",-5,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectile",0,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectile",5,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectile",10,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectile",15,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectile",20,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectile",25,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectile",30,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectile",35,false)
        goto PickupFinish

      PickupAttackLevel5Coop:
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectileCoop",-35,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectileCoop",-30,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectileCoop",-25,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectileCoop",-20,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectileCoop",-15,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectileCoop",-10,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectileCoop",-5,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectileCoop",0,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectileCoop",5,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectileCoop",10,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectileCoop",15,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectileCoop",20,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectileCoop",25,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectileCoop",30,false)
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyCalamityBladeProjectileCoop",35,false)
        goto PickupFinish

      // Finishing stuff
      PickupFinish:
        TNT1 A 0 A_TakeInventory("SamsaraDoomguyCalamityBladeCharge")
        stop
    }
}

actor SamsaraDoomguyCalamityBladeProjectile
{
    Projectile
    Radius 16
    Height 8
    Speed 20
    Damage 10
    DamageType "DoomDamageTypeFire"
    RenderStyle "Add"
    DeathSound "doomguy/calamityblade/explode"
    Decal "DoomBladeScorch"
    Obituary "$SAMSARA_DOOMGUY_OB_SLOT7_1"
    -BLOODSPLATTER
    //+RIPPER
    +THRUACTORS
    States
    {
      Spawn:
        DHTB A 0 Bright Light("DOOMROCKET")
        DHTB AAABBBCCC 1 Bright Light("DOOMROCKET") A_GiveInventory("SamsaraDoomguyCalamityBladeProjectile_Predictor")
        loop

      Death:
        DHTB DE 3 Bright Light("DOOMROCKET_X1")
        DHTB FG 3 Bright Light("DOOMROCKET_X2")
        DHTB HI 3 Bright Light("DOOMROCKET_X3")
        stop
    }
}

actor SamsaraDoomguyCalamityBladeProjectile_Predictor : Trigger
{
    States
    {
      Pickup:
        TNT1 A 0 A_SetArg(0,sqrt(velx*velx+vely*vely)*1000/sqrt(velx*velx+vely*vely+velz*velz))
        TNT1 A 0 A_SetArg(1,velz*1000/sqrt(velx*velx+vely*vely+velz*velz))
        TNT1 A 0 A_SetArg(2,sqrt(velx*velx+vely*vely+velz*velz)/2)
        TNT1 A 0 A_SetMass(-args[2])
      PickupLoop:
        TNT1 A 0 A_JumpIf(mass >= args[2], "PickupStop")
        TNT1 A 0 A_SpawnItemEx("SamsaraDoomguyCalamityBladeProjectile_Explosion",args[0]/1000.0*mass,0,args[1]/1000.0*mass,0,0,0,0,SXF_TRANSFERPOINTERS)
        TNT1 A 0 A_SetMass(mass+radius)
        loop
    }
}

actor SamsaraDoomguyCalamityBladeProjectile_Explosion
{
    Projectile
    Radius 16
    Height 8
    DamageType "DoomDamageTypeFire"
    Obituary "$SAMSARA_DOOMGUY_OB_SLOT7_1"
    -BLOODSPLATTER // blood effect doesn't work anyway due to not being a true ripper
    +DONTBLAST
    +DONTREFLECT
    +DONTSPLASH
    +FORCERADIUSDMG
    +NODAMAGETHRUST
    +NOINTERACTION
    +NOTIMEFREEZE
    States
    {
      Spawn:
        TNT1 A 0
        TNT1 A 1 A_Explode(random(1,8)*10,16,0,false,16)
        stop
    }
}

actor SamsaraDoomguyCalamityBladeProjectileCoop : SamsaraDoomguyCalamityBladeProjectile
{
    Species "Player"
    +THRUSPECIES
}
